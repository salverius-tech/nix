# .drone.yml

kind: pipeline
type: docker
name: default


trigger:
  event:
    - push
    - pull_request
  path:
    include:
      - install/auto/* 

steps:
- name: build iso file
  image: nixos/nix
  commands:
    - cp install/auto/default.nix .
    - cp install/auto/configuration.nix .
    - cp install/auto/hardware-configuration.nix .
    - mkdir -p /drone/src/outbound
    - cp default.nix /drone/src/outbound
    # - nix-build

- name: scp iso file to remote host
  image: appleboy/drone-scp
  settings:
    host:
      from_secret: remote_host
    username:
      from_secret: ssh_username
    key:
      from_secret: ssh_key
    source: /drone/src/outbound/default.nix
    # source: result/iso/*
    target: /tmp
    recursive: true
    strip_components: 2
    port: 22

- name: notification
  image: appleboy/drone-discord
  settings:
    webhook_id: 1008599816563064873
    webhook_token: ZfHVejau6_fSxxOWHI-kMGLgy1ZHMwWQSjmiLOqGxFPjtrLQ3gxuxf8ea37wPzKYTMnP
    message: >
       📝 {{repo.name}} / {{commit.branch}} - {{commit.message}}
       {{#success build.status}}
         ✅ succeeded  for 👷‍♂️ build {{build.number}}
       {{else}}
         🛑 failed for 👷‍♂️ build {{build.number}}
       {{/success}}       
  when:
    status:
      - failure
      - success

trigger:
  event:
    - promote
    - push
    - pull_request